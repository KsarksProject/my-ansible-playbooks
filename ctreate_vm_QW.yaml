---
- name: Create VM from QCOW2
  hosts: localhost
  connection: local
  vars:
    proxmox_host: "172.28.0.251"
    proxmox_user: "root@pam"
    proxmox_password: "{{ lookup('env', 'PROXMOX_PASSWORD') }}" # Храните пароль через Ansible Vault
    proxmox_node: "pve-in"
    vm_name: "new-vm"
    vm_id: "105"  # Уникальный ID для новой VM
    storage: "srv-bs2"
    qcow2_path: "/mnt/pve/srv-bs2/qcow2/2022.qcow2"  # Путь к вашему QCOW2-файлу
    ansible_python_interpreter: /usr/bin/python3.11

  tasks:
    - name: Install Proxmoxer library
      pip:
        name: proxmoxer
        executable: /usr/bin/python3.11

    - name: Create a new VM
      community.general.proxmox_kvm:
        api_host: "{{ proxmox_host }}"
        api_user: "{{ proxmox_user }}"
        api_password: "{{ proxmox_password }}"
        node: "{{ proxmox_node }}"
        vmid: "{{ vm_id }}"
        name: "{{ vm_name }}"
        cores: 4
        memory: 8192
        net: "model=virtio,bridge=vmbr0"
        scsihw: "virtio-scsi-pci"
        boot: "scsi0"
        bootdisk: "scsi0"
        onboot: true
        state: present

    - name: Attach QCOW2 disk
      command: >
        qm set {{ vm_id }}
        --scsi0 {{ storage }}:0,import-from={{ qcow2_path }}

    - name: Start VM
      community.general.proxmox_kvm:
        api_host: "{{ proxmox_host }}"
        api_user: "{{ proxmox_user }}"
        api_password: "{{ proxmox_password }}"
        node: "{{ proxmox_node }}"
        vmid: "{{ vm_id }}"
        state: started
